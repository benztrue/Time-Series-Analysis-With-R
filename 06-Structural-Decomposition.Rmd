# Structural Decomposition

## Component of a time series

A time series can be considered as composed of 4 main components: **trend**, **cycle**, **seasonality**, and the **irregular** or remainder/residual component.

```{r  echo=FALSE}
knitr::include_graphics("images/Structure.png")
```

*   The **Trend** component is the longest-term behavior of a time series, or a systematic change in a time series. The simplest model for a trend is a linear increase or decrease, but the trend has not to be linear. In the AirPassengers time series there is a clear upward trend. A distinction is made between **deterministic** and **stochastic** trends:

  -   A **deterministic trend** is a *fixed function of time*. If a series has a deterministic trend, it will likely appear to grow or decline steadily over time. That is, the increase (or decrease) in the value of the series will be a direct function of time. Deterministic trends have plausible physical explanations (for example, a deterministic increasing trend in the data may be related to an increasing population). A series with deterministic trend is also called *trend-stationary*.
  -   A **stochastic trend** appears to be unpredictable. It wanders up and down, or shows change of direction at unpredictable times. An example of stochastic trend is provided by the so-called *random walk* process, and time series like that are also said to be characterized by a *unit root* and *difference stationary*.

```{r}
library(xts)
data("AirPassengers")
AirPassengers_xts <- as.xts(AirPassengers)
plot.xts(AirPassengers_xts)
```  

*   The **Seasonal** component is a repeated pattern occurring at a fixed time period such as the time of the year or the day of the week (the frequency of seasonality, which is always a fixed and known frequency). There is a clear seasonal variation in the AirPassenger time series: bookings were highest during the summer months of June, July, and August and lowest during the autumn/winter months.

```{r}
plot.xts(AirPassengers_xts["1954-01/1955-12"])
```  

It is possible to plot the distributions of data by months by using the function *boxplot* and *cycle*, to visualize the increasing number of passengers during the summer months. In this case, *cycle* is used to refer to the positions of each observation in the (yearly, in this case) cycle of observations (every year is considered to be a cycle of 12 observations).

```{r}
boxplot(AirPassengers ~ cycle(AirPassengers))
```

*   The **cyclical** component is a pattern that does not correspond to a fixed calendar period, but exhibits fluctuations (rises and falls) not occurring at a fixed frequency (none of these is apparent in the airline bookings time series). The cycle component is therefore different from the seasonal variation in that the former does not follow a fixed calendar frequency. The cyclic component of the series is often considered along with the trend part (*trend-cycle*).

*   The **irregular** or remainder/residual component is the random-like part of the series.

Along with the analysis of the peaks (see previous chapter), analyzing a time series based on these structural parts can be an important exploratory step. It helps understanding the likely causes of the series features and formulate an appropriate time series model. For instance, in the case of the AirPassengers series, we could hypothesize that the *increasing trend* is due to the rising prosperity in the aftermath of the Second World War, greater availability of aircraft, cheaper flights due to competition between airlines, and an increasing population. The *seasonal* variation, instead, seems to coincide with vacation periods.

## Structural decomposition

**Decomposition methods** try to identify and separate the above mentioned parts of a time series. Usually they consider together the trend and cycle (*trend-cycle*) - the longer-term changes in the series - and the *seasonal* factors - periodic fluctuations of constant length happening at a specific calendar frequency).

There are two main ways through which these elements can be combined together: in the **additive** and the **multiplicative** form:

*   The **additive model** ($x_{t} = m_{t} + s_{t} + z_{t}$, where $x_{t}$ is the observed time series, $m_{t}$ is the trend-cycle component, $s_{t}$ is the seasonal component and $z_{t}$ is the residual) is useful when the seasonal variation is relatively constant over time
*   The **multiplicative model** ($x_{t} = m_{t} * s_{t} * z_{t}$) is useful when the the seasonal effects tends to increase as the trend increases.

There are different methods to decompose a time series. Here we consider the function **decompose**. This function is defined as *Classical Seasonal Decomposition by Moving Averages*. The function *decompose* uses a **moving average (MA)** approach to filter the data. Moving average is a classical approach to extract the trend from a time series by averaging out the seasonal effects. 

### Moving Average 

Moving average is a process that replaces each value $x_{t}$ with an average of its current value $x_{t}$ and its immediate neighbors in the past and future. For instance, it is possible to calculate a simple moving average by using the closest neighbors of a point, as follows: $x_{t} = \frac{1}{3} (x_{t-1} + x_{t} + x_{t+1})$. This is called *Centered Moving Average*.

The number of neighbors in the past and future is determined by the analyst and is also called *width of the window*. The time window for the moving average is chosen by considering the frequency of the data and their seasonal effects. For instance, monthly data, which are supposed to show monthly seasonality (for instance, in the AirPassengers data there are more passengers during the summer months), can be averaged by using a period of 12 months (six months before and after each point. Since we have an even number of months, some other calculation are necessary. For instance, the moving average value for July, is calculated by averaging the average of January up to December, and the average of February up to January. R functions do this for you).

The centered moving average is an example of a **smoothing** procedure that is applied retrospectively to a time series with the objective of identifying an underlying signal or trend. Smoothing procedures usually use points before and after the time at which the smoothed estimate is to be calculated. A consequence is that the smoothed series will have *some points missing at the beginning and the end* unless the smoothing algorithm is adapted for the end points. In the case of monthly data, for instance, the moving average filter determines the lost of the first and last six months of data.

Smoothing procedures like moving average, allows the main underlying trend to emerge by filtering out seasonality and noise, so they are used to get an idea of the long-term underlying process of a time series.

```{r}
elections_news <- read_csv("data/elections-stories-over-time-20210111144254.csv", 
                           col_types = cols(date = col_date(format = "%Y-%m-%d")))

en <- as.xts(x = elections_news$ratio, order.by = elections_news$date)

en2 <- rollmean(en, k = 2)
en4 <- rollmean(en, k = 4)
en8 <- rollmean(en, k = 8)
en16 <- rollmean(en, k = 16)
en32 <- rollmean(en, k = 32)

enALL <- merge.xts(en, en2, en4, en8, en16, en32)

# notice the NA elements increasing as the width of the moving average increase
head(enALL, 10) 
```

```{r}
plot.xts(enALL["2015-01-01/2016-01-01"], multi.panel = T)
```

### Decompose

To apply the function *decompose*, we need a **ts** object.

Considering the AirPassengers time series, since the seasonal effect tends to increase as the trend increases, we can use a multiplicative model.

```{r}
AirPassengers_dec <- decompose(AirPassengers, type="multiplicative")
plot(AirPassengers_dec)
```

As an example of *additive model* we can use data from the "Seatbels" data set. 

```{r}
data("Seatbelts")
plot.ts(Seatbelts[,5])
```

```{r}
Seatbelts_dec <- decompose(Seatbelts[,5], type="additive")
plot(Seatbelts_dec)
```

The **residual** part of the model should be (approximately) **random**, which indicates that the model explained (most of) the significant patterns in the data (the *"signal"*), leaving out the *"noise"*. 

```{r}
par(mfrow = c(1,2))
plot.ts(Seatbelts_dec$random, main="Residuals", ylab="")
hist(Seatbelts_dec$random, breaks = 25, freq = F, main = "Histogram")
lines(density(Seatbelts_dec$random, na.rm = T), col="red")
```


We can re-create the original time series starting from its elements (we don't actually need to do that, it is just for illustrative purposes). 

```{r}
par(mfrow=c(2,1))
plot(AirPassengers_dec$trend * AirPassengers_dec$seasonal * AirPassengers_dec$random,  
     xlim=c(1950, 1960), ylim=c(0,600), main = "'Re-composed' series", ylab="")

plot(AirPassengers, xlim=c(1950, 1960),ylim=c(0,600),  main = "Original series", ylab="")
```




## Exercises
Carry out the following exploratory time series analysis in R using either the chocolate or the beer production data:

  a) Produce a time plot of the data. Plot the aggregated annual series and a boxplot that summarizes the observed values for each season, and comment on the plots.
  b) Decompose the series into the components trend, seasonal effect, and residuals, and plot the decomposed series. Produce a plot of the trend with a superimposed seasonal effect.


